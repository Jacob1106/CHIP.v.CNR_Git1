```{R}
source("/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/Myfunctions.R")
```
```{R}
library(GenomicRanges)
library(rtracklayer)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(org.Hs.eg.db)
library(ChIPseeker)
library(tidyverse)
library(ChIPpeakAnno)
library(ggvenn)
library(clusterProfiler)
library(ggupset)
library(ReactomePA)
library(plyranges)
```

```{R}
txdb <- TxDb.Hsapiens.UCSC.hg38.knownGene

file_list <- list(CHIP = "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/H3K27me3/BroadPeakFiles/ChiP/SJHGG059115_C129-LTC42_AAVS1_D7_R1-H3K27me3-AB4_REP1_peaks.broadPeak",
                CHIP2 = "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/H3K27me3/BroadPeakFiles/ChiP/SJHGG059115_C130-LTC42_AAVS1_D7_R2-H3K27me3-AB4_REP1_peaks.broadPeak",
                CHIP3 = "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/H3K27me3/BroadPeakFiles/ChiP/SJHGG059115_C131-LTC42_AAVS1_D7_R3-H3K27me3-AB4_REP1_peaks.broadPeak",
                CNR1 = "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/H3K27me3/BroadPeakFiles/CNR/SJHGG059115_C145-LTC42_Ctrl-H3K27me3-AB4_R1.macs2_peaks.broadPeak",
                CNR2 = "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/H3K27me3/BroadPeakFiles/CNR/SJHGG059115_C145-LTC42_Ctrl-H3K27me3-AB4_R2.macs2_peaks.broadPeak"
                )
data <- import_samples(file_list)



CNR_List <- data[4:5]
CHIP_List <- data[1:3]

#Accounting for Overlaps: 
CHIP_GRL <- GRangesList(CHIP_List)
CHIP <- overlapGRangeList(CHIP_GRL, num_of_overlaps_required = 1)

CNR_GRL <- GRangesList(CNR_List)
CNR <- overlapGRangeList(CNR_GRL, num_of_overlaps_required = 0)

#Making Venn Diagram of overlaps between CHIP and CNR 
# custom_venn_diagram(conditionA = "CHIP", conditionB = "CNR", DataA = CHIP, DataB = CNR)
```

Differential Peak Anaylsis: 

```{R}
overlaps <- findOverlaps(CHIP, CNR)

uniqueCHIP <- CHIP[-queryHits(overlaps)]
uniqueCNR <- CNR[-subjectHits(overlaps)]

overlapCHIP <- CHIP[queryHits(overlaps)]
overlapCNR <- CNR[subjectHits(overlaps)]
```
Writing BED files: 

```{R}
#unique Peak files 


write_bed(uniqueCHIP, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/uniqueCHIP_NA_P.bed")
write_bed(uniqueCNR, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/uniqueCNR_NA_P.bed")

#Overlapped Peaks: 
write_bed(overlapCHIP, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/overlap_CHIP_NA_P.bed")
write_bed(overlapCNR, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/overlap_CNR_NA_P.bed")

#Filtered and Merged BEDs: 
write_bed(CHIP, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/filtered_CHIP_NA_P.bed")
write_bed(CNR, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/BEDFiles/H3K27_BED/filtered_CNR_NA_P.bed")
```

Proportion Overlap: 

```{R}
propOverlabTibble <- proportionOverlapTibble(object1 = CNR, object2 = CHIP, overlapobject1 = overlapCNR, overlapobject2 = overlapCHIP, object1_unique = uniqueCNR, object2_unique = uniqueCHIP)
write.csv(propOverlabTibble, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/H3K27me3_Analysis/Proportion_Overlap_Tables/H3K27_NA_P.csv")
write_xlsx(propOverlabTibble, "/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/H3K27me3_Analysis/Proportion_Overlap_Tables/H3K27_NA_P.xlsx" )
```

Width Analysis: 
```{R}

widthGGplot <- compareGRangeWidth(Obj1 = CNR, Obj2 = CHIP)
ggsave("/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/H3K27me3_Analysis/WidthAnalysisPlots/H3K27_NA_P.png", widthGGplot, height = 7, width = 7, dpi = 300)


```

Peak Annotation 
```{R}
peakAnno_Chip <- annotatePeak(CHIP, tssRegion = c(-3000, 3000), TxDb = txdb, annoDb = "org.Hs.eg.db")
peakAnno_CNR <- annotatePeak(CNR, tssRegion = c(-3000, 3000), TxDb = txdb, annoDb = "org.Hs.eg.db")

#Unique Peak Annotations: 

unique_peak_anno_chip <- annotatePeak(uniqueCHIP, tssRegion = c(-3000, 3000), TxDb = txdb, annoDb = "org.Hs.eg.db")
unique_peak_anno_cnr <- annotatePeak(uniqueCNR, tssRegion = c(-3000, 3000), TxDb = txdb, annoDb = "org.Hs.eg.db")

overlapRegions <- annotatePeak(overlapCNR, tssRegion = c(-3000, 3000), TxDb = txdb, annoDb = "org.Hs.eg.db")

```

Peak Analysis: 
```{R}
pdf("/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/H3K27me3_Analysis/PeakAnnotations/H3K27_PeakAnnoation_Bar_NA_P.pdf", heigh = 3, width = 10)
par(mfrow = c(1, 2))
plotAnnoBar(unique_peak_anno_chip, title = "H3K27me3 Unique Chip Peak annotation")

plotAnnoBar(unique_peak_anno_cnr, title = "H3K27me3 Unique CNR Peak annotation")

plotAnnoBar(overlapRegions, title = "H3K27me3 Overlap Peak annotation")
dev.off()

pdf("/Volumes/groups/bakergrp/projects/baker_data/bakergrp/analyses/JM/ChIP.v.CnR/GeneralR_script_CHIP_CUT/H3K27me3_Analysis/PeakAnnotations/H3K27_PeakAnnoation_Pie_NA_P.pdf", heigh = 7, width = 7)
par(mfrow = c(1, 2))
plotAnnoPie(unique_peak_anno_chip, title = "Chip Unique")
plotAnnoPie(unique_peak_anno_cnr, title = "Cnr Unique")
plotAnnoPie(overlapRegions, title = "Overlap")
dev.off()

```